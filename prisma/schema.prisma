// VettdRE Database Schema
// Prisma ORM schema for PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum OrgTier {
  solo
  pro
  enterprise
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  paused
}

enum UserRole {
  owner
  admin
  manager
  agent
  viewer
}

enum ContactType {
  landlord
  buyer
  seller
  renter
}

enum ContactStatus {
  lead
  active
  client
  past_client
  archived
}

enum ConfidenceLevel {
  high
  medium
  low
}

enum PropertyType {
  house
  condo
  co_op
  townhouse
  multi_family
  land
  commercial
  rental_unit
}

enum TransactionType {
  sale
  rental
  new_development
}

enum PropertyStatus {
  available
  pending
  under_contract
  sold
  leased
  off_market
}

enum DealStatus {
  open
  won
  lost
}

enum PipelineType {
  sales
  rental
  new_development
  custom
}

enum ActivityType {
  email
  call
  text
  showing
  note
  meeting
  document
  system
}

enum ActivityDirection {
  inbound
  outbound
}

enum TaskType {
  follow_up
  call
  email
  showing
  document
  review
  meeting
  custom
}

enum TaskPriority {
  urgent
  high
  medium
  low
}

enum TaskStatus {
  pending
  in_progress
  completed
  skipped
  overdue
}

enum ShowingStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show
}

enum InterestLevel {
  hot
  warm
  neutral
  cold
}

enum TemplateChannel {
  email
  sms
}

enum AutomationTrigger {
  new_lead
  stage_change
  score_change
  no_activity
  task_overdue
  showing_completed
  custom
}

// ============================================================
// MODELS
// ============================================================

model Organization {
  id                   String             @id @default(uuid())
  name                 String
  slug                 String             @unique
  tier                 OrgTier            @default(solo)
  subscriptionStatus   SubscriptionStatus @default(trialing) @map("subscription_status")
  stripeCustomerId     String?            @map("stripe_customer_id")
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  trialEndsAt          DateTime?          @map("trial_ends_at")
  maxUsers             Int                @default(1) @map("max_users")
  aiLookupsLimit       Int                @default(50) @map("ai_lookups_limit")
  aiLookupsUsed        Int                @default(0) @map("ai_lookups_used")
  aiLookupsResetAt     DateTime?          @map("ai_lookups_reset_at")
  settings             Json               @default("{}")
  logoUrl              String?            @map("logo_url")
  website              String?
  phone                String?
  address              String?
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  users                User[]
  contacts             Contact[]
  properties           Property[]
  pipelines            Pipeline[]
  deals                Deal[]
  activities           Activity[]
  tasks                Task[]
  showings             Showing[]
  emailTemplates       EmailTemplate[]
  automations          Automation[]
  auditLogs            AuditLog[]
  prospectingLists     ProspectingList[]
  prospectingItems     ProspectingItem[]
  emailMessages        EmailMessage[]
  emailLabels          EmailLabel[]
  followUpReminders    FollowUpReminder[]
  calendarEvents       CalendarEvent[]
  showingSlots         ShowingSlot[]
  leadAssignmentRule   LeadAssignmentRule?
  aiSettings           AiSettings?
  brandSettings        BrandSettings?

  @@map("organizations")
}

model User {
  id               String    @id @default(uuid())
  orgId            String    @map("org_id")
  authProviderId   String?   @unique @map("auth_provider_id")
  email            String
  fullName         String    @map("full_name")
  role             UserRole  @default(agent)
  avatarUrl        String?   @map("avatar_url")
  phone            String?
  timezone         String    @default("America/New_York")
  title            String?
  licenseNumber    String?   @map("license_number")
  brokerage        String?
  invitedBy        String?   @map("invited_by")
  isActive         Boolean   @default(true) @map("is_active")
  isApproved       Boolean   @default(false) @map("is_approved")
  lastLoginAt      DateTime? @map("last_login_at")
  notificationPrefs Json     @default("{\"email\": true, \"push\": true, \"sms\": false}") @map("notification_prefs")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedContacts Contact[]    @relation("AssignedAgent")
  assignedDeals    Deal[]       @relation("DealAgent")
  activities       Activity[]
  assignedTasks    Task[]       @relation("TaskAssignee")
  createdTasks     Task[]       @relation("TaskCreator")
  completedTasks   Task[]       @relation("TaskCompleter")
  assignedShowings Showing[]
  createdTemplates EmailTemplate[]
  createdAutomations Automation[]
  auditLogs        AuditLog[]
  prospectingLists ProspectingList[] @relation("ListCreator")
  gmailAccounts    GmailAccount[]
  emailSignature   EmailSignature?
  notificationPreferences NotificationPreferences?
  workingHours     WorkingHours?
  syncSettings     SyncSettings?
  calendarEvents   CalendarEvent[]
  showingSlots     ShowingSlot[]

  @@unique([orgId, email])
  @@map("users")
}

model Contact {
  id                String        @id @default(uuid())
  orgId             String        @map("org_id")
  assignedTo        String?       @map("assigned_to")
  firstName         String        @map("first_name")
  lastName          String        @map("last_name")
  email             String?
  phone             String?
  secondaryPhone    String?       @map("secondary_phone")
  address           String?
  city              String?
  state             String?
  zip               String?
  contactType       ContactType   @default(renter) @map("contact_type")
  status            ContactStatus @default(lead)
  source            String?
  sourceDetail      String?       @map("source_detail")
  tags              String[]      @default([])
  qualificationScore Int?         @map("qualification_score")
  scoreUpdatedAt     DateTime?    @map("score_updated_at")
  enrichmentStatus   String       @default("pending") @map("enrichment_status")
  lastContactedAt   DateTime?     @map("last_contacted_at")
  lastActivityAt    DateTime?     @map("last_activity_at")
  totalActivities   Int           @default(0) @map("total_activities")
  preferences       Json          @default("{}")
  typeData          Json?         @map("type_data")
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  organization      Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedAgent     User?         @relation("AssignedAgent", fields: [assignedTo], references: [id], onDelete: SetNull)
  enrichmentProfiles EnrichmentProfile[]
  prospectingItems   ProspectingItem[]
  qualificationScores QualificationScore[]
  deals             Deal[]
  activities        Activity[]
  tasks             Task[]
  showings          Showing[]
  propertyInterests ContactPropertyInterest[]
  emailMessages     EmailMessage[]
  followUpReminders FollowUpReminder[]
  calendarEvents    CalendarEvent[]
  showingSlots      ShowingSlot[]

  @@index([orgId, status])

  @@index([orgId, qualificationScore(sort: Desc)])
  @@index([orgId, email])
  @@index([orgId, lastName, firstName])
  @@map("contacts")
}

model EnrichmentProfile {
  id                String          @id @default(uuid())
  contactId         String          @map("contact_id")
  version           Int             @default(1)
  employer          String?
  jobTitle          String?         @map("job_title")
  industry          String?
  companySize       String?         @map("company_size")
  careerTenureYears Int?            @map("career_tenure_years")
  incomeRangeLow    Int?            @map("income_range_low")
  incomeRangeHigh   Int?            @map("income_range_high")
  incomeConfidence  ConfidenceLevel? @map("income_confidence")
  currentAddress    String?         @map("current_address")
  currentCity       String?         @map("current_city")
  currentState      String?         @map("current_state")
  currentZip        String?         @map("current_zip")
  ownsProperty      Boolean?        @map("owns_property")
  propertyValueEst  Int?            @map("property_value_est")
  mortgageStatus    String?         @map("mortgage_status")
  rentVsOwn         String?         @map("rent_vs_own")
  linkedinUrl       String?         @map("linkedin_url")
  facebookUrl       String?         @map("facebook_url")
  instagramUrl      String?         @map("instagram_url")
  twitterUrl        String?         @map("twitter_url")
  otherSocials      Json            @default("{}") @map("other_socials")
  profilePhotoUrl   String?         @map("profile_photo_url")
  lifeEvents        Json            @default("[]") @map("life_events")
  education         Json            @default("[]")
  aiSummary         String?         @map("ai_summary")
  aiInsights        Json            @default("[]") @map("ai_insights")
  rawData           Json            @default("{}") @map("raw_data")
  dataSources       String[]        @default([]) @map("data_sources")
  confidenceLevel   ConfidenceLevel @default(low) @map("confidence_level")
  enrichedAt        DateTime        @default(now()) @map("enriched_at")
  expiresAt         DateTime?       @map("expires_at")
  contact           Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)
  qualificationScores QualificationScore[]

  @@unique([contactId, version])
  @@index([contactId])
  @@map("enrichment_profiles")
}

model QualificationScore {
  id                    String           @id @default(uuid())
  contactId             String           @map("contact_id")
  enrichmentProfileId   String?          @map("enrichment_profile_id")
  totalScore            Int              @map("total_score")
  financialCapacity     Int              @default(0) @map("financial_capacity")
  intentSignals         Int              @default(0) @map("intent_signals")
  identityVerification  Int              @default(0) @map("identity_verification")
  engagementLevel       Int              @default(0) @map("engagement_level")
  marketFit             Int              @default(0) @map("market_fit")
  scoreExplanation      String?          @map("score_explanation")
  factorDetails         Json             @default("{}") @map("factor_details")
  scoringModelVersion   String           @default("v1.0") @map("scoring_model_version")
  excludedFactors       String[]         @default([]) @map("excluded_factors")
  scoredAt              DateTime         @default(now()) @map("scored_at")
  contact               Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  enrichmentProfile     EnrichmentProfile? @relation(fields: [enrichmentProfileId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@map("qualification_scores")
}

model Property {
  id               String         @id @default(uuid())
  orgId            String         @map("org_id")
  createdBy        String?        @map("created_by")
  address          String
  unitNumber       String?        @map("unit_number")
  city             String
  state            String
  zip              String?
  neighborhood     String?
  latitude         Decimal?       @db.Decimal(10, 7)
  longitude        Decimal?       @db.Decimal(10, 7)
  propertyType     PropertyType   @map("property_type")
  transactionType  TransactionType @map("transaction_type")
  status           PropertyStatus @default(available)
  price            Decimal?       @db.Decimal(12, 2)
  pricePerSqft     Decimal?       @db.Decimal(8, 2) @map("price_per_sqft")
  monthlyRent      Decimal?       @db.Decimal(10, 2) @map("monthly_rent")
  monthlyCc        Decimal?       @db.Decimal(10, 2) @map("monthly_cc")
  monthlyTaxes     Decimal?       @db.Decimal(10, 2) @map("monthly_taxes")
  bedrooms         Int?
  bathrooms        Decimal?       @db.Decimal(3, 1)
  sqft             Int?
  yearBuilt        Int?           @map("year_built")
  mlsNumber        String?        @map("mls_number")
  listingUrl       String?        @map("listing_url")
  listedAt         DateTime?      @map("listed_at")
  description      String?
  images           Json           @default("[]")
  developmentName  String?        @map("development_name")
  buildingName     String?        @map("building_name")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  organization     Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deals            Deal[]
  showings         Showing[]
  contactInterests ContactPropertyInterest[]

  @@index([orgId, status])
  @@index([orgId, transactionType])
  @@index([orgId, city])
  @@map("properties")
}

model Pipeline {
  id            String       @id @default(uuid())
  orgId         String       @map("org_id")
  name          String
  pipelineType  PipelineType @map("pipeline_type")
  stages        Json         @default("[]")
  isDefault     Boolean      @default(false) @map("is_default")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deals         Deal[]

  @@index([orgId])
  @@map("pipelines")
}

model Deal {
  id               String     @id @default(uuid())
  orgId            String     @map("org_id")
  contactId        String     @map("contact_id")
  propertyId       String?    @map("property_id")
  assignedTo       String?    @map("assigned_to")
  pipelineId       String     @map("pipeline_id")
  stageId          String     @map("stage_id")
  stageEnteredAt   DateTime   @default(now()) @map("stage_entered_at")
  name             String?
  dealValue        Decimal?   @db.Decimal(12, 2) @map("deal_value")
  offerPrice       Decimal?   @db.Decimal(12, 2) @map("offer_price")
  askingPrice      Decimal?   @db.Decimal(12, 2) @map("asking_price")
  commissionRate   Decimal?   @db.Decimal(5, 4) @map("commission_rate")
  commissionAmount Decimal?   @db.Decimal(10, 2) @map("commission_amount")
  expectedCloseDate DateTime? @map("expected_close_date") @db.Date
  actualCloseDate   DateTime? @map("actual_close_date") @db.Date
  winProbability   Int?       @map("win_probability")
  riskFlags        Json       @default("[]") @map("risk_flags")
  nextBestAction   String?    @map("next_best_action")
  status           DealStatus @default(open)
  lostReason       String?    @map("lost_reason")
  notes            String?
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  closedAt         DateTime?  @map("closed_at")
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact          Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  property         Property?    @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  assignedAgent    User?        @relation("DealAgent", fields: [assignedTo], references: [id], onDelete: SetNull)
  pipeline         Pipeline     @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  activities       Activity[]
  tasks            Task[]
  showings         Showing[]
  calendarEvents   CalendarEvent[]

  @@index([orgId, status])
  @@index([contactId])
  @@index([pipelineId, stageId])
  prospectingItems ProspectingItem[]

  @@map("deals")
}

model Activity {
  id             String            @id @default(uuid())
  orgId          String            @map("org_id")
  contactId      String            @map("contact_id")
  dealId         String?           @map("deal_id")
  userId         String?           @map("user_id")
  type           ActivityType
  direction      ActivityDirection?
  subject        String?
  body           String?
  metadata       Json              @default("{}")
  isAiGenerated  Boolean           @default(false) @map("is_ai_generated")
  aiDraftAccepted Boolean?         @map("ai_draft_accepted")
  occurredAt     DateTime          @default(now()) @map("occurred_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  organization   Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact        Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal           Deal?             @relation(fields: [dealId], references: [id], onDelete: SetNull)
  user           User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([contactId, occurredAt(sort: Desc)])
  @@index([orgId, type])
  @@map("activities")
}

model Task {
  id              String      @id @default(uuid())
  orgId           String      @map("org_id")
  contactId       String?     @map("contact_id")
  dealId          String?     @map("deal_id")
  assignedTo      String?     @map("assigned_to")
  createdBy       String?     @map("created_by")
  title           String
  description     String?
  type            TaskType    @default(follow_up)
  priority        TaskPriority @default(medium)
  dueAt           DateTime?   @map("due_at")
  reminderAt      DateTime?   @map("reminder_at")
  status          TaskStatus  @default(pending)
  completedAt     DateTime?   @map("completed_at")
  completedBy     String?     @map("completed_by")
  isAiGenerated   Boolean     @default(false) @map("is_ai_generated")
  aiReasoning     String?     @map("ai_reasoning")
  aiSuggestedAction String?   @map("ai_suggested_action")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact         Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal            Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  assignee        User?        @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator         User?        @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  completer       User?        @relation("TaskCompleter", fields: [completedBy], references: [id], onDelete: SetNull)

  @@index([assignedTo, status, dueAt])
  @@index([orgId, status])
  @@map("tasks")
}

model Showing {
  id              String        @id @default(uuid())
  orgId           String        @map("org_id")
  contactId       String        @map("contact_id")
  propertyId      String        @map("property_id")
  dealId          String?       @map("deal_id")
  assignedTo      String?       @map("assigned_to")
  scheduledAt     DateTime      @map("scheduled_at")
  durationMinutes Int           @default(30) @map("duration_minutes")
  status          ShowingStatus @default(scheduled)
  feedback        String?
  interestLevel   InterestLevel? @map("interest_level")
  followUpNotes   String?       @map("follow_up_notes")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  organization    Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact         Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  property        Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  deal            Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  assignee        User?         @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([orgId, scheduledAt])
  @@map("showings")
}

model EmailTemplate {
  id              String          @id @default(uuid())
  orgId           String          @map("org_id")
  createdBy       String?         @map("created_by")
  name            String
  subject         String?
  body            String
  channel         TemplateChannel @default(email)
  mergeFields     String[]        @default([]) @map("merge_fields")
  timesUsed       Int             @default(0) @map("times_used")
  lastUsedAt      DateTime?       @map("last_used_at")
  isAiGenerated   Boolean         @default(false) @map("is_ai_generated")
  category        String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  organization    Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  creator         User?           @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@map("email_templates")
}

model Automation {
  id              String            @id @default(uuid())
  orgId           String            @map("org_id")
  createdBy       String?           @map("created_by")
  name            String
  description     String?
  triggerType     AutomationTrigger @map("trigger_type")
  triggerConfig   Json              @default("{}") @map("trigger_config")
  conditions      Json              @default("[]")
  actions         Json              @default("[]")
  isActive        Boolean           @default(true) @map("is_active")
  runsCount       Int               @default(0) @map("runs_count")
  lastRunAt       DateTime?         @map("last_run_at")
  lastError       String?           @map("last_error")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  organization    Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  creator         User?             @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  runs            AutomationRun[]

  @@index([orgId, triggerType, isActive])
  @@map("automations")
}

model AutomationRun {
  id              String    @id @default(uuid())
  automationId    String    @map("automation_id")
  contactId       String?   @map("contact_id")
  dealId          String?   @map("deal_id")
  triggerData     Json      @default("{}") @map("trigger_data")
  actionsTaken    Json      @default("[]") @map("actions_taken")
  status          String    @default("success")
  errorMessage    String?   @map("error_message")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  automation      Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@map("automation_runs")
}

model ContactPropertyInterest {
  id            String        @id @default(uuid())
  contactId     String        @map("contact_id")
  propertyId    String        @map("property_id")
  interestLevel InterestLevel @default(neutral) @map("interest_level")
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  contact       Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  property      Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([contactId, propertyId])
  @@map("contact_property_interests")
}

model AuditLog {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  userId      String?  @map("user_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  changes     Json?
  metadata    Json     @default("{}")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@map("audit_log")
}

model ProspectingList {
  id          String   @id @default(cuid())
  orgId       String   @map("org_id")
  createdBy   String   @map("created_by")
  name        String
  description String?
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  creator      User         @relation("ListCreator", fields: [createdBy], references: [id])
  items        ProspectingItem[]

  @@map("prospecting_lists")
}

model ProspectingItem {
  id               String   @id @default(cuid())
  listId           String   @map("list_id")
  orgId            String   @map("org_id")
  address          String
  borough          String?
  zip              String?
  block            String?
  lot              String?
  bin              String?
  neighborhood     String?
  totalUnits       Int?     @map("total_units")
  residentialUnits Int?     @map("residential_units")
  yearBuilt        Int?     @map("year_built")
  numFloors        Int?     @map("num_floors")
  buildingArea     Int?     @map("building_area")
  lotArea          Int?     @map("lot_area")
  buildingClass    String?  @map("building_class")
  zoning           String?
  assessedValue    Int?     @map("assessed_value")
  ownerName        String?  @map("owner_name")
  ownerAddress     String?  @map("owner_address")
  ownerType        String?  @map("owner_type")
  lastSalePrice    Int?     @map("last_sale_price")
  lastSaleDate     String?  @map("last_sale_date")
  status           String   @default("new")
  notes            String?
  contactId        String?  @map("contact_id")
  dealId           String?  @map("deal_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  list         ProspectingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact      Contact?        @relation(fields: [contactId], references: [id])
  deal         Deal?           @relation(fields: [dealId], references: [id])

  @@map("prospecting_items")
}


// ============================================================
// Gmail Integration
// ============================================================

model GmailAccount {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  email        String
  accessToken  String    @map("access_token")
  refreshToken String    @map("refresh_token")
  tokenExpiry  DateTime  @map("token_expiry")
  historyId    String?   @map("history_id")
  syncedAt     DateTime? @map("synced_at")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@map("gmail_accounts")
}

model EmailMessage {
  id              String   @id @default(uuid())
  orgId           String   @map("org_id")
  gmailMessageId  String   @map("gmail_message_id")
  threadId        String?  @map("thread_id")
  contactId       String?  @map("contact_id")
  direction       String   // "inbound" | "outbound"
  fromEmail       String   @map("from_email")
  fromName        String?  @map("from_name")
  toEmails        String[] @map("to_emails")
  ccEmails        String[] @default([]) @map("cc_emails")
  subject         String?
  bodyText        String?  @map("body_text")
  bodyHtml        String?  @map("body_html")
  snippet         String?
  labelIds        String[] @default([]) @map("label_ids")
  isRead          Boolean  @default(false) @map("is_read")
  isStarred       Boolean  @default(false) @map("is_starred")
  hasAttachments  Boolean  @default(false) @map("has_attachments")
  isArchived      Boolean  @default(false) @map("is_archived")
  isDeleted       Boolean  @default(false) @map("is_deleted")
  isPinned        Boolean  @default(false) @map("is_pinned")
  snoozedUntil    DateTime? @map("snoozed_until")
  category        String?   // "lead", "newsletter", "personal", "transactional", "spam"
  receivedAt      DateTime @map("received_at")

  // AI parsing results
  aiParsed        Boolean  @default(false) @map("ai_parsed")
  leadSource      String?  @map("lead_source")
  leadIntent      String?  @map("lead_intent")
  extractedName   String?  @map("extracted_name")
  extractedPhone  String?  @map("extracted_phone")
  extractedBudget String?  @map("extracted_budget")
  extractedArea   String?  @map("extracted_area")
  aiSummary       String?  @map("ai_summary")
  sentimentScore  Int?     @map("sentiment_score")

  createdAt       DateTime     @default(now()) @map("created_at")
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact         Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)

  threadLabels     EmailThreadLabel[]

  @@unique([orgId, gmailMessageId])
  @@index([orgId, contactId])
  @@index([orgId, receivedAt(sort: Desc)])
  @@index([orgId, leadSource])
  @@index([orgId, threadId])
  @@index([orgId, category])
  @@index([orgId, snoozedUntil])
  @@map("email_messages")
}

// ============================================================
// Email Labels & Follow-ups
// ============================================================

model EmailLabel {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  color     String   // hex color e.g. "#ef4444"
  icon      String?  // emoji icon
  createdAt DateTime @default(now()) @map("created_at")

  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  threadLabels EmailThreadLabel[]

  @@unique([orgId, name])
  @@map("email_labels")
}

model EmailThreadLabel {
  id       String @id @default(uuid())
  threadId String @map("thread_id")
  labelId  String @map("label_id")
  emailMessageId String? @map("email_message_id")

  label        EmailLabel    @relation(fields: [labelId], references: [id], onDelete: Cascade)
  emailMessage EmailMessage? @relation(fields: [emailMessageId], references: [id], onDelete: Cascade)

  @@unique([threadId, labelId])
  @@map("email_thread_labels")
}

model FollowUpReminder {
  id          String    @id @default(uuid())
  orgId       String    @map("org_id")
  threadId    String    @map("thread_id")
  contactId   String?   @map("contact_id")
  status      String    @default("pending") // "pending", "dismissed", "completed"
  reason      String    // e.g. "no_reply_24h"
  dueAt       DateTime  @map("due_at")
  dismissedAt DateTime? @map("dismissed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contact      Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@unique([orgId, threadId, reason])
  @@index([orgId, status, dueAt])
  @@map("follow_up_reminders")
}

// ============================================================
// Portfolio Intelligence
// ============================================================
model Portfolio {
  id            String   @id @default(uuid())
  name          String   // Primary entity name (e.g., "Parkway Management NY LLC")
  slug          String   @unique
  totalBuildings Int     @default(0)
  totalUnits    Int      @default(0)
  totalValue    Float    @default(0)
  avgDistress   Float    @default(0)
  borough       String?
  neighborhood  String?
  entityNames   String[] // All linked entity names (LLCs, individuals)
  headOfficers  String[] // Known head officers
  addresses     String[] // Known business addresses
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  buildings     PortfolioBuilding[]
}

model PortfolioBuilding {
  id          String   @id @default(uuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  bbl         String   // Borough-Block-Lot
  boroCode    String
  block       String
  lot         String
  address     String
  borough     String
  units       Int      @default(0)
  floors      Int      @default(0)
  yearBuilt   Int      @default(0)
  assessedValue Float  @default(0)
  ownerName   String?
  buildingClass String?
  zoning      String?
  createdAt   DateTime @default(now())

  @@unique([portfolioId, bbl])
}

// ============================================================
// Settings Models
// ============================================================

model EmailSignature {
  id          String  @id @default(uuid())
  userId      String  @unique @map("user_id")
  template    String  @default("classic") // "classic", "with_logo", "minimal"
  html        String  @db.Text
  logoUrl     String? @map("logo_url")
  accentColor String  @default("#2563EB") @map("accent_color")
  linkedinUrl String? @map("linkedin_url")
  websiteUrl  String? @map("website_url")
  isActive    Boolean @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("email_signatures")
}

model NotificationPreferences {
  id                 String  @id @default(uuid())
  userId             String  @unique @map("user_id")
  newLeadEmail       Boolean @default(true) @map("new_lead_email")
  newLeadPush        Boolean @default(true) @map("new_lead_push")
  followUpEmail      Boolean @default(true) @map("follow_up_email")
  followUpPush       Boolean @default(true) @map("follow_up_push")
  newEmailPush       Boolean @default(true) @map("new_email_push")
  taskDueEmail       Boolean @default(true) @map("task_due_email")
  taskDuePush        Boolean @default(true) @map("task_due_push")
  taskOverdueEmail   Boolean @default(true) @map("task_overdue_email")
  weeklySummaryEmail Boolean @default(true) @map("weekly_summary_email")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("notification_preferences")
}

model WorkingHours {
  id       String @id @default(uuid())
  userId   String @unique @map("user_id")
  timezone String @default("America/New_York")
  schedule Json   // { mon: { active: true, start: "09:00", end: "18:00" }, ... }
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("working_hours")
}

model LeadAssignmentRule {
  id           String  @id @default(uuid())
  orgId        String  @unique @map("org_id")
  method       String  @default("manual") // "round_robin", "by_source", "by_geography", "manual"
  rules        Json?   // { "streeteasy": "agent-uuid-1", ... }
  agentOrder   Json?   @map("agent_order") // ["agent-uuid-1", ...]
  lastAssigned String? @map("last_assigned")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@map("lead_assignment_rules")
}

model AiSettings {
  id                  String  @id @default(uuid())
  orgId               String  @unique @map("org_id")
  autoResponseEnabled Boolean @default(false) @map("auto_response_enabled")
  autoResponseMode    String  @default("draft") // "draft", "auto_send", "off"
  responseDelay       Int     @default(5) @map("response_delay")
  responseTone        String  @default("professional") @map("response_tone")
  customInstructions  String? @map("custom_instructions") @db.Text
  autoParseEmails     Boolean @default(true) @map("auto_parse_emails")
  autoCategorize      Boolean @default(true) @map("auto_categorize")
  parseModel          String  @default("sonnet") @map("parse_model")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  organization        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@map("ai_settings")
}

model BrandSettings {
  id           String  @id @default(uuid())
  orgId        String  @unique @map("org_id")
  logoUrl      String? @map("logo_url")
  primaryColor String  @default("#2563EB") @map("primary_color")
  companyName  String? @map("company_name")
  tagline      String?
  websiteUrl   String? @map("website_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@map("brand_settings")
}

model SyncSettings {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  autoSync      Boolean  @default(true) @map("auto_sync")
  syncFrequency Int      @default(15) @map("sync_frequency")
  syncDepth     String   @default("30d") @map("sync_depth")
  syncLabels    String[] @default(["INBOX", "SENT"]) @map("sync_labels")
  lastSyncAt    DateTime? @map("last_sync_at")
  totalSynced   Int      @default(0) @map("total_synced")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("sync_settings")
}

// ============================================================
// Calendar
// ============================================================

model CalendarEvent {
  id               String    @id @default(uuid())
  orgId            String    @map("org_id")
  userId           String    @map("user_id")
  googleEventId    String?   @map("google_event_id")
  googleCalendarId String?   @map("google_calendar_id")

  title            String
  description      String?   @db.Text
  location         String?

  startAt          DateTime  @map("start_at")
  endAt            DateTime  @map("end_at")
  allDay           Boolean   @default(false) @map("all_day")
  timezone         String    @default("America/New_York")

  recurring        Boolean   @default(false)
  recurrenceRule   String?   @map("recurrence_rule")

  eventType        String    @default("general") // "showing","meeting","open_house","inspection","closing","task_deadline","deal_milestone","general"
  contactId        String?   @map("contact_id")
  propertyId       String?   @map("property_id")
  dealId           String?   @map("deal_id")
  showingId        String?   @map("showing_id")

  propertyAddress  String?   @map("property_address")
  unitNumber       String?   @map("unit_number")

  status           String    @default("confirmed") // "confirmed","tentative","cancelled"
  color            String    @default("#3B82F6")

  attendees        Json?

  syncedAt         DateTime? @map("synced_at")
  lastModified     DateTime? @map("last_modified")
  source           String    @default("vettdre") // "vettdre","google","scheduler"

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact          Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  deal             Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  showingSlots     ShowingSlot[]

  @@unique([orgId, googleEventId])
  @@index([orgId, startAt])
  @@index([userId, startAt])
  @@index([contactId])
  @@index([propertyAddress])
  @@map("calendar_events")
}

model ShowingSlot {
  id               String    @id @default(uuid())
  orgId            String    @map("org_id")
  userId           String    @map("user_id")
  propertyAddress  String    @map("property_address")
  unitNumber       String?   @map("unit_number")

  startAt          DateTime  @map("start_at")
  endAt            DateTime  @map("end_at")
  duration         Int       @default(30)

  isBooked         Boolean   @default(false) @map("is_booked")
  bookedByName     String?   @map("booked_by_name")
  bookedByEmail    String?   @map("booked_by_email")
  bookedByPhone    String?   @map("booked_by_phone")
  bookedAt         DateTime? @map("booked_at")
  contactId        String?   @map("contact_id")
  calendarEventId  String?   @map("calendar_event_id")

  notes            String?

  createdAt        DateTime  @default(now()) @map("created_at")

  organization     Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact          Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  calendarEvent    CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)

  @@index([orgId, propertyAddress, startAt])
  @@map("showing_slots")
}
